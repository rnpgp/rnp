name: windows-msvc
on:
  push:
    branches:
      - master
      - 'release/**'
      - maxirmx-2020-clang
    paths-ignore:
      - '/*.sh'
      - '/.*'
      - '/_*'
      - 'Brewfile'
      - 'docs/**'
      - '**.adoc'
      - '**.md'
      - '**.nix'
      - 'flake.lock'
      - '.github/workflows/*.yml'
      - '!.github/workflows/windows-msvc.yml'
  pull_request:
    paths-ignore:
      - '/*.sh'
      - '/.*'
      - '/_*'
      - 'Brewfile'
      - 'docs/**'
      - '**.adoc'
      - '**.md'
      - '**.nix'
      - 'flake.lock'

concurrency:
  group: '${{ github.workflow }}-${{ github.job }}-${{ github.head_ref || github.ref_name }}'
  cancel-in-progress: true

env:
  VCPKG_DIR: 'C:\\vcpkg'

jobs:
  build_and_test:
    name: Windows-2019 msvc [arch ${{ matrix.arch.name }}, toolset ${{ matrix.toolset }} ]
    runs-on: windows-2019
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    strategy:
      fail-fast: false
      matrix:
        arch:
          - { name: 'x64',    triplet: 'x64-windows' }
          - { name: 'Win32',  triplet: 'x86-windows' }
        toolset: [ 'v142', 'ClangCL' ]

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: true
          lfs: true
          fetch-depth: 1

      - name: Cache vcpkg
        uses: actions/cache@v3
        with:
          path: '${{ env.VCPKG_DIR }}/installed'
          key: vcpkg-${{ matrix.arch.triplet }}-${{ hashFiles('vcpkg.txt') }}

      - name: Install vcpkg packages
        shell: bash
        run: vcpkg install --triplet ${{ matrix.arch.triplet }} $(cat vcpkg.txt)

      - name: Configure
        shell: bash
        run: |
          cmake -B build   -G "Visual Studio 16 2019"      \
                           -A ${{ matrix.arch.name }}      \
                           -T ${{ matrix.toolset }}        \
                           -DCMAKE_TOOLCHAIN_FILE=${{ env.VCPKG_DIR }}\\scripts\\buildsystems\\vcpkg.cmake .

      - name: Compile
        shell: bash
        run: cmake --build build --config "Release" --parallel 4

      - name: Test
        shell: bash
        run: ci/test.msvc.sh
